---
title: "FreeSurfer"
author: "nforde"
date: "August 9, 2018"
output: html_document
---
# get libraries/set paths
```{r get libraries & set paths}
library(tidyverse)
library(broom)
library(knitr)
library(car)
library(cowplot)
library(lme4)
library(ggseg)
library(gridExtra)
library(reshape2)
library(mgcv)
library(MatchIt)


## set all the paths
#HCP
behaviour <- read.csv("/projects/nforde/HCP/clinical/demog_behaviour.csv")
restricted <- read.csv("/projects/nforde/HCP/clinical/RESTRICTED.csv")
FS <- read.csv("/projects/nforde/HCP/orig/FreeSurfer.csv")
# subs <- read.table("/projects/nforde/HCP/bin/subs.txt") #list of those with T1, rs-fMRI and dMRI

outdir <- "/projects/nforde/HCP/stats/HCP"

```
# define functions
```{r define functions}

#allometrically scaling out effect of TBV and regressing out age with a GAM
allometric_scale <- function(list, df) {
  # match subset of data for age & sex
  sub <- df[c(list, "Subject", "BrainSeg_No_Vent", "Sex", "Age_in_Yrs")]
    
  sub$treat <- ifelse(sub$Sex == "Male", 1, 0)
  
  match.it <- matchit(treat ~ Age_in_Yrs, data=sub)
  mat.df <- match.data(match.it)
  
  lapply(list, function(i) {
    #fit log-log model on subset
    lmod <-lm(log10(get(i)) ~ log10(BrainSeg_No_Vent), data=mat.df)
    B <- lm.beta(lmod)$standardized.coefficients[2]
    
    #apply B to ROIs of full sample
    logROI <- B * log10(df$BrainSeg_No_Vent)
    ROI <- 10^logROI
    
    # regress out age
    agereg <- gam(ROI ~ s(Age_in_Yrs), data=df)
    return(agereg)
  })
}                   


## for normalising data
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

## function to extract stats from lm
extract <- function(X,num){ 
  lapply(X, function(i){
    F_age <- lapply(get(i), function(f) Anova(f)$"F value"[1])
    F_sex <- lapply(get(i), function(f) Anova(f)$"F value"[2])
    F_XTBVheight <-lapply(get(i), function(f) Anova(f)$"F value"[3])
    p_age <-lapply(get(i), function(f) Anova(f)$"Pr(>F)"[1])
    p_sex <-lapply(get(i), function(f) Anova(f)$"Pr(>F)"[2])
    p_XTBVheight <-lapply(get(i), function(f) Anova(f)$"Pr(>F)"[3])
    adjRsq <- sapply(get(i), function(f) summary(f)$adj.r.squared)
    padj_age <- p.adjust(p_age, method="fdr", n=num)
    padj_sex <- p.adjust(p_sex, method="fdr", n=num)
    padj_XTBVheight <- p.adjust(p_XTBVheight, method="fdr", n=num)
    
    merged <- as.data.frame(cbind(F_age, padj_age, F_sex, padj_sex, F_XTBVheight, padj_XTBVheight, adjRsq))
    return(merged)
  })
}

## function to extract stats from lmer
extract_lmer <- function(i){ 
  Chi_age <- lapply((i), function(f) Anova(f)$"Chisq"[1])
  Chi_sex <- lapply((i), function(f) Anova(f)$"Chisq"[2])
  Chi_hemi <-lapply((i), function(f) Anova(f)$"Chisq"[3])
  Chi_sexXhemi <-lapply((i), function(f) Anova(f)$"Chisq"[4])
  p_age <-lapply((i), function(f) Anova(f)$"Pr(>Chisq)"[1])
  p_sex <-lapply((i), function(f) Anova(f)$"Pr(>Chisq)"[2])
  p_hemi <-lapply((i), function(f) Anova(f)$"Pr(>Chisq)"[3])
  p_sexXhemi <-lapply((i), function(f) Anova(f)$"Pr(>Chisq)"[4])
  padj_age <- p.adjust(p_age, method="fdr")
  padj_sex <- p.adjust(p_sex, method="fdr")
  padj_hemi <- p.adjust(p_hemi, method="fdr")
  padj_sexXhemi <- p.adjust(p_sexXhemi, method="fdr")
    
  merged <- as.data.frame(cbind(Chi_age, padj_age, Chi_sex, padj_sex, Chi_hemi, padj_hemi, Chi_sexXhemi, padj_sexXhemi))
  return(merged)
}

extractT <- function(i, num){
  Tval <- lapply((i), function(f) f$statistic)
  Pval <- lapply((i), function(f) f$p.value)
  dof <- lapply((i), function(f) f$parameter)
   
  Padj <- p.adjust(Pval, method="fdr", n=num)
  Cohen <- (as.numeric(Tval)*2)/sqrt(as.numeric(dof))
  
  merged <- as.data.frame(cbind(Tval, Padj, Cohen))
  return(merged)

}

## function to extract stats from var.test
extract_var <- function(X, num){ 
  VR <- lapply(X, function(f) (f)$"estimate")
  VR_p <- lapply(X, function(f) (f)$"p.value")
  padj_VR <- p.adjust(VR_p, method="fdr", n=num)
  
  merged <- as.data.frame(cbind(VR, padj_VR))
  return(merged)
}

### function to plot and grid multiple figures
plot_box <- function(ROIs, df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x=Sex, color= Sex)) + geom_boxplot(aes_string(y=f)) 
              + theme(axis.title.x = element_blank(), axis.text=element_text(size=8), axis.title=element_text(size=10), legend.position="none"))
  # grid <- do.call(grid.arrange, a)
  return(a)
} #

#same as above, split violin instead of box
plot_vio <- function(ROIs, df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x="Sex", fill= Sex)) + geom_split_violin(aes_string(y=f)) 
              + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.text.y=element_text(size=8),
                      axis.title=element_text(size=10), legend.position="none")
              +stat_summary(aes_string(y=f), fun.data=mean_sdl, fun.args = list(mult = 1), geom="pointrange", shape =95, 
                            size=0.5, position = position_dodge(width = .75)))
  return(a)
} #

plot_age <- function(ROIs,df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x=Age_in_Yrs, color =Sex)) +xlab("Age (years)") 
              + theme(axis.text=element_text(size=8), axis.title=element_text(size=10), legend.position="none") 
              + geom_jitter(aes_string(y=f), width=0.2, size= 0.5) + geom_smooth(aes_string(y=f), span = 0.5))
  return(a)
}

### function to plot measure by sex, grouped by hemisphere
plot_box_hemi <- function(ROIs, df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x=hemi, fill = Sex)) + geom_boxplot(aes_string(y=f)) 
              + theme(axis.title.x = element_blank(), axis.text=element_text(size=8), axis.title=element_text(size=10), legend.position="none"))
  return(a)
} #

#same as above, split violin instead of box
plot_vio_hemi <- function(ROIs, df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x=hemi, fill = Sex)) + geom_split_violin(aes_string(y=f)) 
              + theme(axis.title.x = element_blank(), axis.text=element_text(size=8), axis.title=element_text(size=10), legend.position="none") 
              +stat_summary(aes_string(y=f), fun.data=mean_sdl, fun.args = list(mult = 1), geom="pointrange", shape =95, size=0.5, 
                            position = position_dodge(width = .75)))
  return(a)
} #

# plot X by age and gender
plot_age_hemi <- function(ROIs,df) {
  a <- lapply(ROIs, function(f) ggplot(df, aes(x=Age_in_Yrs, color =Sex)) +xlab("Age (years)") 
              + geom_jitter(aes_string(y=f), width=0.2, size= 0.5) + geom_smooth(aes_string(y=f), span = 0.5) 
              + facet_grid(. ~hemi , scales = "free_y")
              + theme(axis.text=element_text(size=10), axis.title=element_text(size=12), legend.position="none", 
                      strip.text = element_text(size=12)))
  return(a)
}

GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, draw_group = function(self, data, ..., draw_quantiles = NULL){
  data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
  grp <- data[1,'group']
  newdata <- plyr::arrange(transform(data, x = if(grp%%2==1) xminv else xmaxv), if(grp%%2==1) y else -y)
  newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
  newdata[c(1,nrow(newdata)-1,nrow(newdata)), 'x'] <- round(newdata[1, 'x']) 
  if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
    stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <= 
                                              1))
    quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
    aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
    aesthetics$alpha <- rep(1, nrow(quantiles))
    both <- cbind(quantiles, aesthetics)
    quantile_grob <- GeomPath$draw_panel(both, ...)
    ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
  }
  else {
    ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
  }
})

geom_split_violin <- function (mapping = NULL, data = NULL, stat = "ydensity", position = "identity",
                               ..., draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, position = position, show.legend = show.legend,
        inherit.aes = inherit.aes, params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}

```
# organise
```{r organise data}
demogs <- merge(behaviour, restricted, by = "Subject")
#demogs <- filter(demog, !grepl('C', QC_Issue)) # remove those rated C; head coil instability

demogs$Sex <- NA
demogs$Sex[demogs$Gender=="M"] <- "Male"  
demogs$Sex[demogs$Gender=="F"] <- "Female" 

# calc total cerebellum wm and gm vol
FS$FS_Cerebellum_Cort_Vol <- (FS$FS_L_Cerebellum_Cort_Vol + FS$FS_R_Cerebellum_Cort_Vol) ################
FS$FS_Cerebellum_WM_Vol <- (FS$FS_L_Cerebellum_WM_Vol + FS$FS_R_Cerebellum_WM_Vol) ##############

# Isolate vol measures and separate out hemis  
Vol.df <- FS %>% select(contains("Vol")) %>% cbind(FS[1]) 
colnames(Vol.df) <- sub("FS_", "", colnames(Vol.df)) 
colnames(Vol.df) <- sub("_Vol", "", colnames(Vol.df)) 

Vol.R <- Vol.df %>% select(starts_with("R_")) %>% cbind(FS[1])
colnames(Vol.R) <- sub("R_", "", colnames(Vol.R)) 
Vol.R$hemi <- "right" 

Vol.L <- Vol.df %>% select(starts_with("L_")) %>% cbind(FS[1])
colnames(Vol.L) <- sub("L_", "", colnames(Vol.L)) 
Vol.L$hemi <- "left" 

Vol.hemi <- rbind(Vol.R, Vol.L)

Vol.df <- merge(Vol.df, demogs, by=("Subject"))
Vol.hemi <- merge(Vol.hemi, demogs, by=("Subject")) %>% merge(Vol.df[c(1,4)], by=("Subject"))

## Cortical thickness
CT.df <- FS %>% select(contains("Thck")) %>% cbind(FS[1]) 
colnames(CT.df) <- sub("FS_", "", colnames(CT.df)) 
colnames(CT.df) <- sub("_Thck", "", colnames(CT.df)) 

CT.R <- CT.df %>% select(starts_with("R_")) %>% cbind(FS[1])
colnames(CT.R) <- sub("R_", "", colnames(CT.R)) 
CT.R$hemi <- "right" 

CT.L <- CT.df %>% select(starts_with("L_")) %>% cbind(FS[1])
colnames(CT.L) <- sub("L_", "", colnames(CT.L)) 
CT.L$hemi <- "left" 

CT.hemi <- rbind(CT.R, CT.L)

CT.df <- merge(CT.df, demogs, by=("Subject")) %>% merge(Vol.df[c(1,4)], by=("Subject"))
CT.hemi <- merge(CT.hemi, demogs, by=("Subject")) %>% merge(Vol.df[c(1,4)], by=("Subject"))

### Surface Area
SA.df <- FS %>% select(contains("Area")) %>% cbind(FS[1])
colnames(SA.df) <- sub("FS_", "", colnames(SA.df)) 
colnames(SA.df) <- sub("_Area", "", colnames(SA.df)) 

SA.R <- SA.df %>% select(starts_with("R_")) %>% cbind(FS[1])
colnames(SA.R) <- sub("R_", "", colnames(SA.R)) 
SA.R$hemi <- "right" 

SA.L <- SA.df %>% select(starts_with("L_")) %>% cbind(FS[1])
colnames(SA.L) <- sub("L_", "", colnames(SA.L)) 
SA.L$hemi <- "left" 

SA.hemi <- rbind(SA.L, SA.R)

SA.df <- merge(SA.df, demogs, by=("Subject")) %>% merge(Vol.df[c(1,4)], by=("Subject"))
SA.hemi <- merge(SA.hemi, demogs, by=("Subject")) %>% merge(Vol.df[c(1,4)], by=("Subject"))

### lists of variables
overall <- c("Total_GM", "Tot_WM", "Cerebellum_Cort", "Cerebellum_WM") ###########################
overallincTBV <- c("BrainSeg_No_Vent", "Total_GM", "Tot_WM", "Cerebellum_Cort", "Cerebellum_WM") ###############
SubCortLR <- c("L_ThalamusProper", "L_Caudate", "L_Putamen", "L_Pallidum", "L_Hippo", "L_Amygdala", "L_AccumbensArea",
               "R_ThalamusProper", "R_Caudate", "R_Putamen",  "R_Pallidum", "R_Hippo",  "R_Amygdala", "R_AccumbensArea")
SubCort <- c("ThalamusProper", "Caudate", "Putamen", "Pallidum", "Hippo", "Amygdala", "AccumbensArea")
CortLR <- names(CT.df)[2:69]
Cort <- names(CT.hemi)[2:35]
```
# Stats Overall
```{r mean stats global}
### Total Brain Volume (BrainSeg_No_Vent) analysis

TBVageres <- gam(BrainSeg_No_Vent ~ s(Age_in_Yrs), data=Vol.df)
TBVageres1 <- augment(TBVageres)
TBVageres.df <- cbind(Vol.df, TBVageres1) 
TBVageres.df$.residZ <- scale(TBVageres.df$.resid, scale = TRUE) 
TBVage <- t.test(.residZ ~ Sex, data=TBVageres.df)

TBVt <- TBVage$statistic
TBVp <- TBVage$p.value
TBVdof <- TBVage$parameter
TBVpadj <- p.adjust(TBVp, method="fdr", n=5) ############
TBVCohen <- (as.numeric(TBVt)*2)/sqrt(as.numeric(TBVdof))

TBV_out <- as.data.frame(cbind(TBVt, TBVpadj, TBVCohen))
TBV_out <- apply(TBV_out,2,as.character)
TBVout.file <- paste(outdir, "TBV.csv", sep="/")
write.csv(TBV_out, file=TBVout.file, row.names = F)

### make df including residuals from TBV 
Vol.res <- Vol.df

#regressing out age effect
OVres_age  <- lapply(overall, function(i){
  gam(get(i) ~ s(Age_in_Yrs), data=Vol.res)
})

#OVres_full <- allometric_scale(overall, Vol.res)
OVres_full  <- lapply(overall, function(i){
  gam(get(i) ~ s(Age_in_Yrs) + BrainSeg_No_Vent, data=Vol.res)
})

OVage_in  <- lapply(overall, function(i){
  lm(get(i) ~ BrainSeg_No_Vent, data=Vol.res)
})


for (i in 1:length(overall)) {
  res <- augment(OVres_age[[i]])
  names(res) <- paste0(overall[i],"age",names(res))
  Vol.res <- cbind(Vol.res, as.data.frame(res[5]))
}

for (i in 1:length(overall)) {
  res <- augment(OVres_full[[i]])
  names(res) <- paste0(overall[i],"Full",names(res))
  Vol.res <- cbind(Vol.res, as.data.frame(res[6]))
}

for (i in 1:length(overall)) {
  res <- augment(OVage_in[[i]])
  names(res) <- paste0(overall[i],"ageIn",names(res))
  Vol.res <- cbind(Vol.res, as.data.frame(res[5]))
}

#Zscore the data
Vol.resZ <- Vol.res %>% select(contains(".resid")) %>% apply(2, scale, scale = TRUE) %>%
  cbind(Vol.res[c("Sex", "Age_in_Yrs", "Subject")]) %>% merge(TBVageres.df[c("Subject", ".residZ")], by= "Subject")

Vol.Z <- Vol.res %>% select(overall) %>% apply(2, scale, scale = TRUE) %>%
  cbind(Vol.res[c("Sex", "Age_in_Yrs", "Subject")]) 

OVres_age_ls <-Vol.resZ %>% select(contains("age.resid")) %>% names
OVres_full_ls <-Vol.resZ %>% select(contains("Full.resid")) %>% names

overall_age  <- lapply(OVres_age_ls, function(i){
  t.test(get(i) ~ Sex , data=Vol.resZ)
})

overall_full  <- lapply(OVres_full_ls, function(i){
  t.test(get(i) ~ Sex , data=Vol.resZ)
})

OVresid_age <- extractT(overall_age, 5) ############
names(OVresid_age) <- paste0('AgeResid',names(OVresid_age))
OVresid_full <- extractT(overall_full, 5) ############
names(OVresid_full) <- paste0('FullResid',names(OVresid_full))

### merge and write out
OV_out <- cbind(OVresid_age, OVresid_full)
OV_out <- apply(OV_out,2,as.character)
rownames(OV_out) <- overall
OVout.file <- paste(outdir, "overall.csv", sep="/")
write.csv(OV_out, file=OVout.file, row.names = T)

```
# Overall variance testing
```{r VR stats global}
# raw model
Vol.M <- subset(Vol.resZ, Sex == "Male")
Vol.F <- subset(Vol.resZ, Sex == "Female")

TBVageres.M <- subset(TBVageres.df, Sex == "Male")
TBVageres.F <- subset(TBVageres.df, Sex == "Female")

TBVres_var <- var.test(TBVageres.M$.residZ, TBVageres.F$.residZ)
TBVres_est <- TBVres_var$estimate
TBVres_VRp <- TBVres_var$p.value
TBVres_VRpadj <- p.adjust(TBVres_VRp, method="fdr", n=5) ###########

TBV_VR <- cbind(TBVres_est, TBVres_VRpadj) 
OVoutTBV_VR.file <- paste(outdir, "TBV_VR.csv", sep="/")
write.csv(TBV_VR, file=OVoutTBV_VR.file, row.names = T)


# residual mods
overall_var.resAge  <- lapply(OVres_age_ls, function(i){
  var.test(Vol.M[[i]], Vol.F[[i]])
})
OVvar.resAge <- extract_var(overall_var.resAge, 5)###########

overall_var.resfull  <- lapply(OVres_full_ls, function(i){
  var.test(Vol.M[[i]], Vol.F[[i]])
})
OVvar.resfull <- extract_var(overall_var.resfull, 5)###########

# write out
# names(OVvar) <- paste0('VR_',names(OVvar))
names(OVvar.resAge) <- paste0('VR_Age_',names(OVvar.resAge))
names(OVvar.resfull) <- paste0('VR_Full_',names(OVvar.resfull))

OV_VR <- cbind(OVvar.resAge, OVvar.resfull)
OV_VR <- apply(OV_VR,2,as.character)
rownames(OV_VR) <- overall
OVoutVR.file <- paste(outdir, "overallVR.csv", sep="/")
write.csv(OV_VR, file=OVoutVR.file, row.names = T)

```
# Overall Plots raw (for age plots) and minus age (box and vio)
```{r gloabal plots}
OVplots_age <- plot_age(overallincTBV, Vol.df)

OV_to_graph_age <- c(".residZ", "Total_GMage.resid", "Tot_WMage.resid", "Cerebellum_Cortage.resid", "Cerebellum_WMage.resid") #########
OVplots_box <- plot_box(OV_to_graph_age, Vol.resZ)
OVplots_vio <- plot_vio(OV_to_graph_age, Vol.resZ) 

plot_grid(plotlist=OVplots_age, align="hv", ncol = 3)  
plot_grid(plotlist=OVplots_vio, align="hv", ncol = 3)

OV2 <- plot_grid(plotlist=OVplots_age, align="hv", ncol = 3)  
OV3 <- plot_grid(plotlist=OVplots_vio, align="hv", ncol = 3)

OVfile.age <- paste(outdir, "OVgraphAge.png", sep="/")
OVfile.vio <- paste(outdir, "OVgraphVio.png", sep="/")

ggsave(OVfile.age, OV2, dpi=300, width = 21, height = 14, units = "cm") #####
ggsave(OVfile.vio, OV3, dpi=300, width = 21, height = 14, units = "cm") #####

```
# Overall Plots - minus TBV (age plots), minus age and TBV (vio)
```{r global plots without TBV}

OV_to_graph_full <- c(".residZ", OVres_full_ls) 

OVplots_vio.res <- plot_vio(OV_to_graph_full, Vol.resZ)

plot_grid(plotlist=OVplots_vio.res, align="hv", ncol = 3)

OV3.res <- plot_grid(plotlist=OVplots_vio.res, align="hv", ncol =3)

OVfile.vio.res <- paste(outdir, "OVgraphVioRES.png", sep="/")

#ggsave(OVfile.vio.res, OV3.res, dpi=300, width = 21, height = 14, units = "cm") #########

#alt config
AltOV1 <- plot_grid((OVplots_vio[[1]] + ylab("Total Brain Volume") +ylim(-4,4)),
                    (OVplots_vio[[2]]+ ylab("Cerebral Grey Matter")+ylim(-4,4)), 
                    (OVplots_vio[[3]]+ ylab("Cerebral White Matter")+ylim(-4,4)),
                    (OVplots_vio[[4]]+ ylab("Cerebellar Grey Matter")+ylim(-4,4)), 
                    (OVplots_vio[[5]]+ ylab("Cerebellar White Matter")+ylim(-4,4)), NULL ,
                    (OVplots_vio.res[[2]]+ ylab("Cerebral Grey Matter")+ylim(-4,4)),  
                    (OVplots_vio.res[[3]]+ ylab("Cerebral White Matter")+ylim(-4,4)), 
                    (OVplots_vio.res[[4]]+ ylab("Cerebellar Grey Matter")+ylim(-4,4)),  
                    (OVplots_vio.res[[5]]+ ylab("Cerebellar White Matter")+ylim(-4,4)), align="hv", ncol =5, 
                    labels=c('A', 'B', 'C', 'D', 'E', ' ', 'F', 'G', 'H', 'I', 'J'), label_size=10)

OVfile.alt1 <- paste(outdir, "OVgraphVio_comb.png", sep="/")

ggsave(OVfile.alt1, AltOV1, dpi=300, width = 21, height = 8, units = "cm")

```

# sub cortical stats mean 
```{r mean stats subcortial}
## Stats sub cort

## SubCort simple with interactions
subCort_simpX  <- lapply(SubCortLR, function(i){
  lm(get(i) ~ Age_in_Yrs*Sex, data=Vol.df)
})

## SubCort simple
subCort_simp  <- lapply(SubCortLR, function(i){
  lm(get(i) ~ Age_in_Yrs +Sex, data=Vol.df)
})

### make df including residuals from TBV 
SC.res <- Vol.df
SCres_age  <- lapply(SubCortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs), data=SC.res)
})

#SCres_Full  <- allometric_scale(SubCortLR, SC.res)
SCres_Full  <- lapply(SubCortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs) + BrainSeg_No_Vent, data=SC.res)
})

SCage_in  <- lapply(SubCortLR, function(i){
  lm(get(i) ~ BrainSeg_No_Vent, data=SC.res)
})

for (i in 1:length(SubCortLR)) {
  res <- augment(SCres_age[[i]])
  names(res) <- paste0(SubCortLR[i],"age",names(res))
  SC.res <- cbind(SC.res, as.data.frame(res[5]))
}

for (i in 1:length(SubCortLR)) {
  res <- augment(SCres_Full[[i]])
  names(res) <- paste0(SubCortLR[i],"Full",names(res))
  SC.res <- cbind(SC.res, as.data.frame(res[6]))
}

for (i in 1:length(SubCortLR)) {
  res <- augment(SCage_in[[i]])
  names(res) <- paste0(SubCortLR[i],"ageIn",names(res))
  SC.res <- cbind(SC.res, as.data.frame(res[5]))
}

#norm
SC.resZ <- SC.res %>% select(contains(".resid")) %>% apply(2, scale, scale = TRUE) %>%
  cbind(SC.res[c("Sex", "Age_in_Yrs", "Subject")]) 
SC.Z <- SC.res %>% select(SubCortLR) %>% apply(2, scale, scale = TRUE) %>%
  cbind(SC.res[c("Sex", "Age_in_Yrs", "Subject")]) 

SCres_age_ls <-SC.resZ %>% select(contains("age.resid")) %>% names
SCres_full_ls <-SC.resZ %>% select(contains("Full.resid")) %>% names

subCort_age  <- lapply(SCres_age_ls, function(i){
  t.test(get(i) ~ Sex , data=SC.resZ)
})

subCort_full  <- lapply(SCres_full_ls, function(i){
  t.test(get(i) ~ Sex , data=SC.resZ)
})

numSC <- length(SubCortLR)
SCresid_age <- extractT(subCort_age, numSC)
names(SCresid_age) <- paste0('AgeResid_',names(SCresid_age))
SCresid_full <- extractT(subCort_full, numSC)
names(SCresid_full) <- paste0('FullResid_',names(SCresid_full))

## merge and write out
SC_out <- cbind(SCresid_age, SCresid_full) 
SC_out <- apply(SC_out,2,as.character)
rownames(SC_out) <- SubCortLR
SCout.file <- paste(outdir, "SC.csv", sep="/")
write.csv(SC_out, file=SCout.file, row.names = T)

```
# Subcortical variance testing
```{r VR stats subcortial}
# raw model

SC.M.res <- subset(SC.resZ, Sex == "Male") ##SC.res made above includes residuals 
SC.F.res <- subset(SC.resZ, Sex == "Female")

SubCort_var.resAge  <- lapply(SCres_age_ls, function(i){
  var.test(SC.M.res[[i]], SC.F.res[[i]])
})
SCvar.resAge <- extract_var(SubCort_var.resAge, numSC)

SubCort_var.resfull  <- lapply(SCres_full_ls, function(i){
  var.test(SC.M.res[[i]], SC.F.res[[i]])
})
SCvar.resfull <- extract_var(SubCort_var.resfull, numSC)

# write out
names(SCvar.resAge) <- paste0('VR_Age_',names(SCvar.resAge))
names(SCvar.resfull) <- paste0('VR_Full_',names(SCvar.resfull))

SC_VR <- cbind(SCvar.resAge, SCvar.resfull)
SC_VR <- apply(SC_VR,2,as.character)
rownames(SC_VR) <- SubCortLR
SCoutVR.file <- paste(outdir, "SC_VR.csv", sep="/")
write.csv(SC_VR, file=SCoutVR.file, row.names = T)

```

# Subcortical Plots - raw (for age plots) and minus age (box and vio)
```{r subcortical plots}
# make df with hemi and residual data
SC.R.res <- SC.resZ %>% select(starts_with("R_")) %>% cbind(SC.resZ[c("Subject")])
colnames(SC.R.res) <- sub("R_", "", colnames(SC.R.res)) 
SC.R.res$hemi <- "right" 

SC.L.res <- SC.resZ %>% select(starts_with("L_")) %>% cbind(SC.resZ[c("Subject")])
colnames(SC.L.res) <- sub("L_", "", colnames(SC.L.res)) 
SC.L.res$hemi <- "left" 

SC.hemi.res <- rbind(SC.R.res, SC.L.res)
SC.hemi.res <- merge(SC.hemi.res, demogs, by=("Subject")) 

#make lists of regions based on residuals
SC_to_graph_full <-SC.hemi.res %>% select(contains("Full.resid")) %>% names
SC_to_graph_age <-SC.hemi.res %>% select(contains("age.resid")) %>% names

#plot 
SCplots_age <- plot_age_hemi(SubCort, Vol.hemi)
SCplots_vio <- plot_vio_hemi(SC_to_graph_age, SC.hemi.res)

# check what they look like
plot_grid(plotlist=SCplots_age, align="hv", ncol =2)
plot_grid(plotlist=SCplots_vio, align="hv", ncol =3)

# set arrangement
SC2 <- plot_grid(plotlist=SCplots_age, align="hv", ncol =2)
SC3 <- plot_grid(plotlist=SCplots_vio, align="hv", ncol =3)

#set file names
SCfile.age <- paste(outdir, "SCgraphAge.png", sep="/")
SCfile.vio <- paste(outdir, "SCgraphVio.png", sep="/")

#save graphs
ggsave(SCfile.age, SC2, dpi=300, width = 21, height = 24, units = "cm")
ggsave(SCfile.vio, SC3, dpi=300, width = 21, height = 17.82, units = "cm")

```
# Subcortical Plots - minus TBV (age plots), minus age and TBV (vio)
```{r subcortical plots without TBV}
#plot 
SCplots_vio.res <- plot_vio_hemi(SC_to_graph_full, SC.hemi.res)

#check config
plot_grid(plotlist=SCplots_vio.res, align="hv", ncol = 3)

#set config
SC3.res <- plot_grid(plotlist=SCplots_vio.res, align="hv", ncol =3)

#set file names
SCfile.vio.res <- paste(outdir, "SCgraphVioRES.png", sep="/")

#save
ggsave(SCfile.vio.res, SC3.res, dpi=300, width = 21, height = 17.82, units = "cm")


#alt config combining with and without TBV
AltSC1 <- plot_grid((SCplots_vio[[1]] + ylab("Thalamus") + ylim(-4,4)), (SCplots_vio.res[[1]]+ ylab("Thalamus")+ ylim(-4,4)), 
                    (SCplots_vio[[2]] +ylab("Caudate")+ ylim(-4,4)), (SCplots_vio.res[[2]] +ylab("Caudate")+ ylim(-4,4)), 
                    (SCplots_vio[[3]] +ylab("Putamen")+ ylim(-4,4)), (SCplots_vio.res[[3]] +ylab("Putamen")+ ylim(-4,4)),
                    (SCplots_vio[[4]] +ylab("Pallidum")+ ylim(-4,4)), (SCplots_vio.res[[4]] +ylab("Pallidum")+ ylim(-4,4)),
                    (SCplots_vio[[5]] +ylab("Hippocampus")+ ylim(-4,4)), (SCplots_vio.res[[5]] +ylab("Hippocampus")+ ylim(-4,4)),
                    (SCplots_vio[[6]] +ylab("Amygdala")+ ylim(-4,4)), (SCplots_vio.res[[6]] +ylab("Amygdala")+ ylim(-4,4)),
                    (SCplots_vio[[7]] +ylab("Nucleus Accumbens")+ ylim(-4,4)), (SCplots_vio.res[[7]] +ylab("Nucleus Accumbens")+ ylim(-4,4)),
                    align="hv", ncol =2)

AltSC3 <- plot_grid((SCplots_vio[[1]] + ylab("Thalamus")+ ylim(-4,4)),  (SCplots_vio[[2]] +ylab("Caudate")+ ylim(-4,4)),
                     (SCplots_vio[[3]] +ylab("Putamen")+ ylim(-4,4)),  (SCplots_vio[[4]] +ylab("Pallidum")+ ylim(-4,4)),
                    (SCplots_vio[[5]] +ylab("Hippocampus")+ ylim(-4,4)),(SCplots_vio[[6]] +ylab("Amygdala")+ ylim(-4,4)), 
                    (SCplots_vio[[7]] +ylab("Nucleus Accumbens")+ ylim(-4,4)),(SCplots_vio.res[[1]]+ ylab("Thalamus")+ ylim(-4,4)), 
                    (SCplots_vio.res[[2]] +ylab("Caudate")+ ylim(-4,4)), (SCplots_vio.res[[3]] +ylab("Putamen")+ ylim(-4,4)),
                    (SCplots_vio.res[[4]] +ylab("Pallidum")+ ylim(-4,4)), (SCplots_vio.res[[5]] +ylab("Hippocampus")+ ylim(-4,4)),
                    (SCplots_vio.res[[6]] +ylab("Amygdala")+ ylim(-4,4)), (SCplots_vio.res[[7]] +ylab("Nucleus Accumbens")+ ylim(-4,4)),
                    align="hv", ncol =7)



SCfile.alt1 <- paste(outdir, "SCgraphVio_comb.png", sep="/")
SCfile.alt3 <- paste(outdir, "SCgraphVio_comb2.png", sep="/")

ggsave(SCfile.alt1, AltSC1, dpi=300, width = 16, height = 29.7, units = "cm")
ggsave(SCfile.alt3, AltSC3, dpi=300, width = 29.7, height = 8, units = "cm")

```

# subcortical atlas plot 
```{r subcortical atlas plots}
areaSC <- c("thalamus proper", "caudate", "putamen", "pallidum", "hippocampus", "amygdala", "accumbens")
leftSC <- cbind(areaSC, "left")
rightSC <- cbind(areaSC, "right")
hemisSC <- rbind(leftSC, rightSC) 
colnames(hemisSC) <- c("area", "hemi")

###### for VR
SCplotVR <- as.data.frame(SC_VR, stringsAsFactors = F) %>% cbind(hemisSC)

#select sig
SCplotVR_sig.raw <- subset(SCplotVR, as.numeric(VR_Age_padj_VR) < 0.05)
SCplotVR_sig.cor <- subset(SCplotVR, as.numeric(VR_Full_padj_VR) < 0.05)

#plot
SCa <- ggseg(SCplotVR_sig.raw, atlas="aseg", mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
                        guides(fill=guide_colorbar(title="VR", 
                        title.position = "left", label.theme = element_text(angle = 0, size= 8))) 

SCb <- ggseg(SCplotVR_sig.cor, atlas="aseg", mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
guides(fill=guide_colorbar(title="VR", title.position = "left", label.theme = element_text(angle = 0, size= 8))) 

#arrange
plot_grid(SCa, SCb, align="hv", ncol = 2, labels=c('A', 'B'),label_size=10)
SC_VR_plot <- plot_grid(SCa, SCb, align="hv", ncol = 2, labels=c('A', 'B'), label_size=10)

#names and save
SC_VR_plot.file <- paste(outdir, "SCatlasVR.png", sep="/")
ggsave(SC_VR_plot.file, SC_VR_plot, dpi=300, width = 21, height = 12, units = "cm")

##mean
SCplot <- as.data.frame(SC_out, stringsAsFactors = F) %>% cbind(hemisSC)
#select sig
SCplot_sig.raw <- subset(SCplot, as.numeric(AgeResid_Padj) < 0.05)
SCplot_sig.cor <- subset(SCplot, as.numeric(FullResid_Padj) < 0.05)

#plot
SCc <- ggseg(SCplot_sig.raw, atlas="aseg", mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF",mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                       breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
  guides(fill=guide_colorbar(direction= "horizontal", title="Cohen's d", title.position = "top", label.theme = element_text(angle = 90, size= 8)))

SCd <- ggseg(SCplot_sig.cor, atlas="aseg", mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF",mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                       breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
  guides(fill=guide_colorbar(title="Cohen's d", title.position = "left", label.theme = element_text(angle = 0, size= 8)))

#arrange
plot_grid(SCc, SCd, align="hv", ncol = 2, labels=c('A', 'B'),label_size=10)
SC_plot <- plot_grid(SCc, SCd, align="hv", ncol = 2, labels=c('A', 'B'), label_size=10)

#names and save
SC_plot.file <- paste(outdir, "SCatlas.png", sep="/")
ggsave(SC_plot.file, SC_plot, dpi=300, width = 21, height = 12, units = "cm")

```
# stats cortical CT means
```{r mean stats CT}

### make df including residuals from TBV 
CT.res <- CT.df
CTres_age  <- lapply(CortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs), data=CT.res)
})

#CTres_Full  <- allometric_scale(CortLR, CT.res)
CTres_Full  <- lapply(CortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs) + BrainSeg_No_Vent, data=CT.res)
})

CTage_in  <- lapply(CortLR, function(i){
  lm(get(i) ~ BrainSeg_No_Vent, data=CT.res)
})

for (i in 1:length(CortLR)) {
  res <- augment(CTres_age[[i]])
  names(res) <- paste0(CortLR[i],"age",names(res))
  CT.res <- cbind(CT.res, as.data.frame(res[5]))
}

for (i in 1:length(CortLR)) {
  res <- augment(CTres_Full[[i]])
  names(res) <- paste0(CortLR[i],"Full",names(res))
  CT.res <- cbind(CT.res, as.data.frame(res[6]))
}

for (i in 1:length(CortLR)) {
  res <- augment(CTage_in[[i]])
  names(res) <- paste0(CortLR[i],"ageIn",names(res))
  CT.res <- cbind(CT.res, as.data.frame(res[5]))
}

#norm
CT.resZ <- CT.res %>% select(contains(".resid")) %>% apply(2, scale, scale = TRUE) %>%
  cbind(CT.res[c("Sex", "Age_in_Yrs", "Subject")]) 
CT.Z <- CT.res %>% select(CortLR) %>% apply(2, scale, scale = TRUE) %>%
  cbind(CT.res[c("Sex", "Age_in_Yrs", "Subject")]) 

CTres_age_ls <-CT.resZ %>% select(contains("age.resid")) %>% names
CTres_full_ls <-CT.resZ %>% select(contains("Full.resid")) %>% names

CT_age  <- lapply(CTres_age_ls, function(i){
  t.test(get(i) ~ Sex , data=CT.resZ)
})

CT_full  <- lapply(CTres_full_ls, function(i){
  t.test(get(i) ~ Sex , data=CT.resZ)
})

numCT <- length(CortLR)
CTresid_age <- extractT(CT_age, numCT)
names(CTresid_age) <- paste0('AgeResid_',names(CTresid_age))
CTresid_full <- extractT(CT_full, numCT)
names(CTresid_full) <- paste0('FullResid_',names(CTresid_full))

## merge and write out
CT_out_tbl <- cbind(CTresid_age, CTresid_full) 
CT_out_tbl <- apply(CT_out_tbl,2,as.character)
rownames(CT_out_tbl) <- CortLR
CTout.file <- paste(outdir, "CT.csv", sep="/")
write.csv(CT_out_tbl, file=CTout.file, row.names = T)

```
#  stats cortical CT variance
```{r VR stats CT}

CT.M.res <- subset(CT.resZ, Sex == "Male") # 
CT.F.res <- subset(CT.resZ, Sex == "Female")

CTCort_var.resAge  <- lapply(CTres_age_ls, function(i){
  var.test(CT.M.res[[i]], CT.F.res[[i]])
})
CTvar.resAge <- extract_var(CTCort_var.resAge, numCT)

CTCort_var.resfull  <- lapply(CTres_full_ls, function(i){
  var.test(CT.M.res[[i]], CT.F.res[[i]])
})
CTvar.resfull <- extract_var(CTCort_var.resfull, numCT)

# write out
names(CTvar.resAge) <- paste0('VR_Age_',names(CTvar.resAge))
names(CTvar.resfull) <- paste0('VR_Full_',names(CTvar.resfull))

CT_VR <- cbind(CTvar.resAge, CTvar.resfull)
CT_VR <- apply(CT_VR,2,as.character)
rownames(CT_VR) <- CortLR
CToutVR.file <- paste(outdir, "CT_VR.csv", sep="/")
write.csv(CT_VR, file=CToutVR.file, row.names = T)

```
# plot CT - raw (for age plots) and minus age (box and vio)
```{r CT plots}
#mk df with hemis and resid data
CT.R.res <- CT.resZ %>% select(starts_with("R_")) %>% cbind(CT.res[c("Subject")])
colnames(CT.R.res) <- sub("R_", "", colnames(CT.R.res)) 
CT.R.res$hemi <- "right" 

CT.L.res <- CT.resZ %>% select(starts_with("L_")) %>% cbind(CT.res[c("Subject")])
colnames(CT.L.res) <- sub("L_", "", colnames(CT.L.res)) 
CT.L.res$hemi <- "left" 

CT.hemi.res <- rbind(CT.R.res, CT.L.res)
CT.hemi.res <- merge(CT.hemi.res, demogs, by=("Subject")) 

#make lists of regions based on residuals
CT_to_graph_age <-CT.hemi.res %>% dplyr::select(contains("age.resid")) %>% names
CT_to_graph_full <-CT.hemi.res %>% dplyr::select(contains("Full.resid")) %>% names

#plot
CTplots_age <- plot_age_hemi(Cort, CT.hemi)
CTplots_vio <- plot_vio_hemi(CT_to_graph_age, CT.hemi.res)

#check arrangement
marrangeGrob(grobs=CTplots_age, ncol =2, nrow =2)
marrangeGrob(grobs=CTplots_vio, ncol =3, nrow =3)

#set arranglement
CT2 <- marrangeGrob(grobs=CTplots_age, ncol =2, nrow =4)
CT3 <- marrangeGrob(grobs=CTplots_vio, ncol =3, nrow =5)

#set file names
CTfile.age <- paste(outdir, "CTgraphAge.pdf", sep="/")
CTfile.vio <- paste(outdir, "CTgraphVio.pdf", sep="/")

#save
ggsave(CTfile.age, CT2, dpi=300, width = 21, height = 29.7, units = "cm")
ggsave(CTfile.vio, CT3, dpi=300, width = 21, height = 29.7, units = "cm")

```
# CT Plots - minus TBV (age plots), minus age and TBV (vio)
```{r CT plots without TBV}
#plot
CTplots_vio.res <- plot_vio_hemi(CT_to_graph_full, CT.hemi.res)

#check arrangment
marrangeGrob(grobs=CTplots_vio.res, ncol = 3, nrow =3)

#set arrangment
CT3.res <- marrangeGrob(grobs=CTplots_vio.res, ncol =3, nrow =5)

#set file names
CTfile.vio.res <- paste(outdir, "CTgraphVioRES.pdf", sep="/")

#save
ggsave(CTfile.vio.res, CT3.res, dpi=300, width = 21, height = 29.7, units = "cm")

```

# CT atlas plot 
```{r Atlas plots CT}
#mk df 
area <- c("banks superior temporal", "caudal anterior cingulate",  "caudal middle frontal", "cuneus", "entorhinal", "fusiform",
                   "inferior parietal", "inferior temporal","isthmus cingulate", "lateral occipital", "lateral orbitofrontal", "lingual",
                   "medial orbito frontal", "middle temporal", "parahippocampal", "para central", "pars opercularis", "pars orbitalis",
                   "pars triangularis", "pericalcarine", "post central", "posterior cingulate", "pre central", "precuneus", 
                   "rostral anterior cingulate", "rostral middle frontal", "superior frontal", "superior parietal", "superior temporal",
                   "supramarginal", "frontal pole", "temporal pole", "transverse temporal", "insula")
left <- cbind(area, "left")
right <- cbind(area, "right")
hemis <- rbind(left, right) 
colnames(hemis) <- c("area", "hemi")

###### for VR
CTplotVR <- as.data.frame(CT_VR, stringsAsFactors = F) %>% cbind(hemis)

## subsets of data that was significant
CTplotVR_sig.raw <- subset(CTplotVR, as.numeric(VR_Age_padj_VR) < 0.05)
CTplotVR_sig.cor <- subset(CTplotVR, as.numeric(VR_Full_padj_VR) < 0.05)

#plot
CTa <- ggseg(CTplotVR_sig.raw, mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
    scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
guides(fill=guide_colorbar(title="VR", title.position = "left", label.theme = element_text(angle = 0, size= 8))) 
CTb <- ggseg(CTplotVR_sig.cor, mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
   scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
guides(fill=guide_colorbar(title="VR", title.position = "left", label.theme = element_text(angle = 0, size= 8)))  

#arrange
plot_grid(CTa, CTb, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)
CT_VR_plot <- plot_grid(CTa, CTb, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)

#names and save
CT_VR_plot.file <- paste(outdir, "CTatlasVR.png", sep="/")
ggsave(CT_VR_plot.file, CT_VR_plot, dpi=300, width = 21, height = 12, units = "cm")

####### for mean
CTplot.df <- as.data.frame(CT_out_tbl, stringsAsFactors = F) %>% cbind(hemis)

## subsets of data that was significant
CTplot_sig.raw <- subset(CTplot.df, as.numeric(AgeResid_Padj) < 0.05)
CTplot_sig.cor <- subset(CTplot.df, as.numeric(FullResid_Padj) < 0.05)

#plot
CTc <- ggseg(CTplot_sig.raw, mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF",mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                       breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
  guides(fill=guide_colorbar(title="Cohen's d", title.position = "left", label.theme = element_text(angle = 0, size= 8)))  
CTd <- ggseg(CTplot_sig.cor, mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF",mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                       breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
  guides(fill=guide_colorbar(title="Cohen's d", title.position = "left", label.theme = element_text(angle = 0, size= 8))) 

#arrange
plot_grid(CTc, CTd, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)
CT_plot <- plot_grid(CTc, CTd, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)

#name and save
CT_plot.file <- paste(outdir, "CTatlas.png", sep="/")
ggsave(CT_plot.file, CT_plot, dpi=300, width = 21, height = 12, units = "cm")

```
# stats cortical SA mean
```{r mean stats SA} 

### make df including residuals from TBV 
SA.res <- SA.df
SAres_age  <- lapply(CortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs), data=SA.res)
})

#SAres_Full  <- allometric_scale(CortLR, SA.res)
SAres_Full  <- lapply(CortLR, function(i){
  gam(get(i) ~ s(Age_in_Yrs) + BrainSeg_No_Vent, data=SA.res)
})

SAage_in  <- lapply(CortLR, function(i){
  lm(get(i) ~ BrainSeg_No_Vent, data=SA.res)
})

for (i in 1:length(CortLR)) {
  res <- augment(SAres_age[[i]])
  names(res) <- paste0(CortLR[i],"age",names(res))
  SA.res <- cbind(SA.res, as.data.frame(res[5]))
}

for (i in 1:length(CortLR)) {
  res <- augment(SAres_Full[[i]])
  names(res) <- paste0(CortLR[i],"Full",names(res))
  SA.res <- cbind(SA.res, as.data.frame(res[6]))
}

for (i in 1:length(CortLR)) {
  res <- augment(SAage_in[[i]])
  names(res) <- paste0(CortLR[i],"ageIn",names(res))
  SA.res <- cbind(SA.res, as.data.frame(res[5]))
}

#norm 
SA.resZ <- SA.res %>% select(contains(".resid")) %>% apply(2, scale, scale = TRUE) %>%
  cbind(SA.res[c("Sex", "Age_in_Yrs", "Subject")]) 
SA.Z <- SA.res %>% select(CortLR) %>% apply(2, scale, scale = TRUE) %>%
  cbind(SA.res[c("Sex", "Age_in_Yrs", "Subject")]) 

SAres_age_ls <-SA.resZ %>% select(contains("age.resid")) %>% names
SAres_full_ls <-SA.resZ %>% select(contains("Full.resid")) %>% names

SA_age  <- lapply(SAres_age_ls, function(i){
  t.test(get(i) ~ Sex , data=SA.resZ)
})

SA_full  <- lapply(SAres_full_ls, function(i){
  t.test(get(i) ~ Sex , data=SA.resZ)
})

numSA <- length(CortLR)
SAresid_age <- extractT(SA_age, numSA)
names(SAresid_age) <- paste0('AgeResid_',names(SAresid_age))
SAresid_full <- extractT(SA_full, numSA)
names(SAresid_full) <- paste0('FullResid_',names(SAresid_full))

## merge and write out
SA_out_tbl <- cbind(SAresid_age, SAresid_full) 
SA_out_tbl <- apply(SA_out_tbl,2,as.character)
rownames(SA_out_tbl) <- CortLR
SAout.file <- paste(outdir, "SA.csv", sep="/")
write.csv(SA_out_tbl, file=SAout.file, row.names = T)

```
# SA variance testing
```{r VR stats SA}

SA.M.res <- subset(SA.resZ, Sex == "Male") # 
SA.F.res <- subset(SA.resZ, Sex == "Female")

SACort_var.resAge  <- lapply(SAres_age_ls, function(i){
  var.test(SA.M.res[[i]], SA.F.res[[i]])
})
SAvar.resAge <- extract_var(SACort_var.resAge, numSA)

SACort_var.resfull  <- lapply(SAres_full_ls, function(i){
  var.test(SA.M.res[[i]], SA.F.res[[i]])
})
SAvar.resfull <- extract_var(SACort_var.resfull, numSA)

# write out
names(SAvar.resAge) <- paste0('VR_Age_',names(SAvar.resAge))
names(SAvar.resfull) <- paste0('VR_Full_',names(SAvar.resfull))

SA_VR <- cbind(SAvar.resAge, SAvar.resfull)
SA_VR <- apply(SA_VR,2,as.character)
rownames(SA_VR) <- CortLR
SAoutVR.file <- paste(outdir, "SA_VR.csv", sep="/")
write.csv(SA_VR, file=SAoutVR.file, row.names = T)

```
# plot SA - raw (for age plots) and minus age (box and vio)
```{r plots SA}
#mk df with hemis and resids
SA.R.res <- SA.resZ %>% select(starts_with("R_")) %>% cbind(SA.resZ[c("Subject")])
colnames(SA.R.res) <- sub("R_", "", colnames(SA.R.res)) 
SA.R.res$hemi <- "right" 

SA.L.res <- SA.resZ %>% select(starts_with("L_")) %>% cbind(SA.resZ[c("Subject")])
colnames(SA.L.res) <- sub("L_", "", colnames(SA.L.res)) 
SA.L.res$hemi <- "left" 

SA.hemi.res <- rbind(SA.R.res, SA.L.res)
SA.hemi.res <- merge(SA.hemi.res, demogs, by=("Subject")) 

#make lits of variable names to graph based of resids
SA_to_graph_age <-SA.hemi.res %>% dplyr::select(contains("age.resid")) %>% names
SA_to_graph_full <-SA.hemi.res %>% dplyr::select(contains("Full.resid")) %>% names

#plot
SAplots_age <- plot_age_hemi(Cort, SA.hemi)
SAplots_vio <- plot_vio_hemi(SA_to_graph_age, SA.hemi.res)

#check arrangement
marrangeGrob(grobs=SAplots_age, ncol =2, nrow =2)
marrangeGrob(grobs=SAplots_vio, ncol =3, nrow =3)

#set arrangement
SA2 <- marrangeGrob(grobs=SAplots_age, ncol =2, nrow =4)
SA3 <- marrangeGrob(grobs=SAplots_vio, ncol =3, nrow =5)

#set file names
SAfile.age <- paste(outdir, "SAgraphAge.pdf", sep="/")
SAfile.vio <- paste(outdir, "SAgraphVio.pdf", sep="/")

#save
ggsave(SAfile.age, SA2, dpi=300, width = 21, height = 29.7, units = "cm")
ggsave(SAfile.vio, SA3, dpi=300, width = 21, height = 29.7, units = "cm")

```

# SA Plots - minus TBV (age plots), minus age and TBV (vio)
```{r plots SA without TBV}
#plot
SAplots_vio.res <- plot_vio_hemi(SA_to_graph_full, SA.hemi.res)

#arrange
marrangeGrob(grobs=SAplots_vio.res, ncol = 3, nrow =3)

#set arrangement
SA3.res <- marrangeGrob(grobs=SAplots_vio.res, ncol =3, nrow =5)

#set file names
SAfile.vio.res <- paste(outdir, "SAgraphVioRES.pdf", sep="/")

#save
ggsave(SAfile.vio.res, SA3.res, dpi=300, width = 21, height = 29.7, units = "cm")

```
# SA atlas plot 
```{r Atlas plots SA}
area <- c("banks superior temporal", "caudal anterior cingulate",  "caudal middle frontal", "cuneus", "entorhinal", "fusiform",
                   "inferior parietal", "inferior temporal","isthmus cingulate", "lateral occipital", "lateral orbitofrontal", "lingual",
                   "medial orbito frontal", "middle temporal", "parahippocampal", "para central", "pars opercularis", "pars orbitalis",
                   "pars triangularis", "pericalcarine", "post central", "posterior cingulate", "pre central", "precuneus", 
                   "rostral anterior cingulate", "rostral middle frontal", "superior frontal", "superior parietal", "superior temporal",
                   "supramarginal", "frontal pole", "temporal pole", "transverse temporal", "insula")

left <- cbind(area, "left")
right <- cbind(area, "right")
hemis <- rbind(left, right) 
colnames(hemis) <- c("area", "hemi")

SAplotVR <- as.data.frame(SA_VR, stringsAsFactors = F) %>% cbind(hemis)

## select subset of sig data
SAplotVR_sig.raw <- subset(SAplotVR, as.numeric(VR_Age_padj_VR) < 0.05)
SAplotVR_sig.cor <- subset(SAplotVR, as.numeric(VR_Full_padj_VR) < 0.05)

#plot
SAa <- ggseg(SAplotVR_sig.raw, mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
    scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
guides(fill=guide_colorbar(title="VR", title.position = "left", label.theme = element_text(angle = 0, size= 8)))  
SAb <- ggseg(SAplotVR_sig.cor, mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
    scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), 
                       breaks=seq(1,2.81,by=0.5)) + theme(axis.title.x = element_blank()) +
  guides(fill=guide_colorbar(title="VR", title.position = "left", label.theme = element_text(angle = 0, size= 8))) 

#arrange
plot_grid(SAa,SAb, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)
SA_VR_plot <- plot_grid(SAa,SAb, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)

#names and save
SA_VR_plot.file <- paste(outdir, "SAatlasVR.png", sep="/")
ggsave(SA_VR_plot.file, SA_VR_plot, dpi=300, width = 21, height = 12, units = "cm")

####### for mean
SAplot.df <- as.data.frame(SA_out_tbl, stringsAsFactors = F) %>% cbind(hemis)

## subsets of data that was significant
SAplot_sig.raw <- subset(SAplot.df, as.numeric(AgeResid_Padj) < 0.05)
SAplot_sig.cor <- subset(SAplot.df, as.numeric(FullResid_Padj) < 0.05)

#plot
SAc <- ggseg(SAplot_sig.raw, mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                      breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
    guides(fill=guide_colorbar(title="Cohen's d", title.position = "left", label.theme = element_text(angle = 0, size= 8)))  
SAd <- ggseg(SAplot_sig.cor, mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), 
                      breaks=seq(-1,1,by=1)) + theme(axis.title.x = element_blank()) + 
  guides(fill=guide_colorbar(title="Cohen's d", title.position = "left", label.theme = element_text(angle = 0, size= 8))) 

#arrange
plot_grid(SAc, SAd, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)
SA_plot <- plot_grid(SAc, SAd, align="hv", ncol = 1, labels=c('A', 'B'),label_size=10)

#name and save
SA_plot.file <- paste(outdir, "SAatlas.png", sep="/")
ggsave(SA_plot.file, SA_plot, dpi=300, width = 21, height = 12, units = "cm")


```

# unit sphere stuff
```{r write out residual files}
colnames(CT.resZ) <- paste0("CT_", colnames(CT.resZ))
colnames(SA.resZ) <- paste0("SA_", colnames(SA.resZ))

All.res <- merge(Vol.resZ, SC.resZ, by="Subject") %>% merge(CT.resZ, by.x="Subject", by.y="CT_Subject") %>% 
  merge(SA.resZ, by.x="Subject", by.y="SA_Subject") %>% 
  select(contains("Full.resid")) %>% cbind(Vol.resZ[c("Subject", "Age_in_Yrs", "Sex")]) 

Allres.file <- paste(outdir, "Allres.csv", sep="/")
write.csv(All.res, file=Allres.file, row.names = T)

All.resAgeIN <- merge(Vol.resZ, SC.resZ, by="Subject") %>% merge(CT.resZ, by.x="Subject", by.y="CT_Subject") %>% 
  merge(SA.resZ, by.x="Subject", by.y="SA_Subject") %>% 
  select(contains("ageIn.resid")) %>% cbind(Vol.resZ[c("Subject", "Age_in_Yrs", "Sex")]) 

AllresAgeIN.file <- paste(outdir, "AllresAgeIN.csv", sep="/")
write.csv(All.resAgeIN, file=AllresAgeIN.file, row.names = T)

colnames(CT.Z) <- paste0("CT_", colnames(CT.Z))
colnames(SA.Z) <- paste0("SA_", colnames(SA.Z))

All.Z <- merge(Vol.Z, SC.Z, by=c("Subject", "Sex", "Age_in_Yrs")) %>% merge(CT.Z, by.x=c("Subject", "Sex", "Age_in_Yrs"), by.y=c("CT_Subject", "CT_Sex", "CT_Age_in_Yrs")) %>% 
  merge(SA.Z, by.x=c("Subject", "Sex", "Age_in_Yrs"), by.y=c("SA_Subject", "SA_Sex", "SA_Age_in_Yrs"))

AllZ.file <- paste(outdir, "AllZ.csv", sep="/")
write.csv(All.Z, file=AllZ.file, row.names = T)

```

# Prep HCP graphs for combining with PNC # need to run FreeSurferPNC.Rmd to have PNC graphs avail
```{r prep figure to combine with other datasets}

#plot required HCP graphs without legends (the same is done for PNC at the end of that script)

##SC
HCP_SCraw <- ggseg(SCplot_sig.raw, atlas="aseg",mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_SCcor <- ggseg(SCplot_sig.cor, atlas="aseg", mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())

HCP_SCrawVR <- ggseg(SCplotVR_sig.raw, atlas="aseg", mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
    scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5))  + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_SCcorVR <- ggseg(SCplotVR_sig.cor, atlas="aseg", mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5))  + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())

##CT
HCP_CTraw <- ggseg(CTplot_sig.raw, mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_CTcor <- ggseg(CTplot_sig.cor, mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())

HCP_CTrawVR <- ggseg(CTplotVR_sig.raw, mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
    scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5))  + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_CTcorVR <- ggseg(CTplotVR_sig.cor, mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5))  + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())

##SA
HCP_SAraw <- ggseg(SAplot_sig.raw, mapping=aes(fill=as.numeric(AgeResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_SAcor <- ggseg(SAplot_sig.cor, mapping=aes(fill=as.numeric(FullResid_Cohen)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#0033FF", mid="white", high="#FF3300", midpoint=0, limits=c(-1.4, 1.4), breaks=seq(-1,1,by=1)) + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())

HCP_SArawVR <- ggseg(SAplotVR_sig.raw, mapping=aes(fill=as.numeric(VR_Age_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5)) +
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
HCP_SAcorVR <- ggseg(SAplotVR_sig.cor, mapping=aes(fill=as.numeric(VR_Full_VR)), colour="black", size=0.4) +
  scale_fill_gradient2(low="#006600", mid="#FFFF99", high="#FF9900", midpoint=1.8, limits=c(1, 2.81), breaks=seq(1,2.81,by=0.5))  + 
  theme(legend.position="none", axis.title.x = element_blank(), axis.text.x= element_blank())
  

## rename HCP OV & SC
HCP_OVplots_vio <- OVplots_vio
HCP_OVplots_vio.res <- OVplots_vio.res
HCP_OVplots_age <- OVplots_age

```
# combine HCP, PNC & OASIS graphs
```{r making combined figures}
outdir_combined <- "/projects/nforde/HCP/stats/combined_figures"

# #arrange
# Comb_SC_plot <- plot_grid(PNC_SCraw, PNC_SCcor, HCP_SCraw, HCP_SCcor, OASIS_SCraw, OASIS_SCcor,
#                           PNC_SCrawVR, PNC_SCcorVR, HCP_SCrawVR,  HCP_SCcorVR, OASIS_SCrawVR, OASIS_SCcorVR, align="hv", ncol = 6,
#           labels=c('A', 'B', 'C', 'D','E', 'F','G', 'H', 'I', 'J','K','L'), label_size=12)
#
# Comb_SA_plot <- plot_grid(PNC_SAraw, HCP_SAraw,  OASIS_SAraw,  PNC_SAcor, HCP_SAcor,  OASIS_SAcor,
#                           PNC_SArawVR, HCP_SArawVR,  OASIS_SArawVR,  PNC_SAcorVR, HCP_SAcorVR,  OASIS_SAcorVR, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', '','D', 'E', 'F', '','',''), label_size=12)
#
# Comb_CT_plot <- plot_grid(PNC_CTraw, HCP_CTraw,  OASIS_CTraw,  PNC_CTcor, HCP_CTcor,  OASIS_CTcor,
#                           PNC_CTrawVR, HCP_CTrawVR,  OASIS_CTrawVR,  PNC_CTcorVR, HCP_CTcorVR,  OASIS_CTcorVR, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', '','D', 'E', 'F', '','',''), label_size=12)
#
# #name and save
# Comb_SA_plot.file <- paste(outdir_combined, "HCP_PNC_OASIS_SAatlas.png", sep="/")
# Comb_CT_plot.file <- paste(outdir_combined, "HCP_PNC_OASIS_CTatlas.png", sep="/")
# Comb_SC_plot.file <- paste(outdir_combined, "HCP_PNC_OASIS_SCatlas.png", sep="/")
# ggsave(Comb_SA_plot.file, Comb_SA_plot, dpi=300, width = 21, height = 12, units = "cm")
# ggsave(Comb_CT_plot.file, Comb_CT_plot, dpi=300, width = 21, height = 12, units = "cm")
# ggsave(Comb_SC_plot.file, Comb_SC_plot, dpi=300, width = 21, height = 12, units = "cm")

##VR only
#arrange
Comb_SC_VR_plot <- plot_grid(PNC_SCrawVR, PNC_SCcorVR, HCP_SCrawVR, HCP_SCcorVR, OASIS_SCrawVR, OASIS_SCcorVR, align="hv", ncol = 6)

# Comb_SA_VR_plot <- plot_grid(PNC_SArawVR, HCP_SArawVR,  OASIS_SArawVR,  PNC_SAcorVR, HCP_SAcorVR,  OASIS_SAcorVR, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', ''), label_size=12)
#
# Comb_CT_VR_plot <- plot_grid(PNC_CTrawVR, HCP_CTrawVR,  OASIS_CTrawVR,  PNC_CTcorVR, HCP_CTcorVR,  OASIS_CTcorVR, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', ''), label_size=12)

Comb_Cort_VR_plot <- plot_grid(PNC_SArawVR, HCP_SArawVR,  OASIS_SArawVR,  PNC_SAcorVR, HCP_SAcorVR,  OASIS_SAcorVR,
                               PNC_CTrawVR, HCP_CTrawVR,  OASIS_CTrawVR,  PNC_CTcorVR, HCP_CTcorVR,  OASIS_CTcorVR, align="hv", ncol = 3)

#name and save
Comb_SC_VR_plot.file <- paste(outdir_combined, "Comb_VR_SCatlas.png", sep="/")
# Comb_SA_VR_plot.file <- paste(outdir_combined, "Comb_VR_SAatlas.png", sep="/")
# Comb_CT_VR_plot.file <- paste(outdir_combined, "Comb_VR_CTatlas.png", sep="/")
Comb_Cort_VR_plot.file <- paste(outdir_combined, "Comb_VR_CORTatlas.png", sep="/")
# ggsave(Comb_SA_VR_plot.file, Comb_SA_VR_plot, dpi=300, width = 21, height = 10, units = "cm")
# ggsave(Comb_CT_VR_plot.file, Comb_CT_VR_plot, dpi=300, width = 21, height = 10, units = "cm")
ggsave(Comb_SC_VR_plot.file, Comb_SC_VR_plot, dpi=300, width = 21, height = 10, units = "cm")
ggsave(Comb_Cort_VR_plot.file, Comb_Cort_VR_plot, dpi=300, width = 21, height = 20, units = "cm")

## mean only
Comb_SC_x_plot <- plot_grid(PNC_SCraw, PNC_SCcor, HCP_SCraw,  HCP_SCcor, OASIS_SCraw, OASIS_SCcor, align="hv", ncol = 6)

# Comb_SA_x_plot <- plot_grid(PNC_SAraw, HCP_SAraw,  OASIS_SAraw,  PNC_SAcor, HCP_SAcor,  OASIS_SAcor, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', ''), label_size=12)
#
# Comb_CT_x_plot <- plot_grid(PNC_CTraw, HCP_CTraw,  OASIS_CTraw,  PNC_CTcor, HCP_CTcor,  OASIS_CTcor, align="hv", ncol = 3,
#           labels=c('A', 'B', 'C', '','', ''), label_size=12)

Comb_Cort_x_plot <- plot_grid(PNC_SAraw, HCP_SAraw,  OASIS_SAraw,  PNC_SAcor, HCP_SAcor,  OASIS_SAcor,
                              PNC_CTraw, HCP_CTraw,  OASIS_CTraw,  PNC_CTcor, HCP_CTcor,  OASIS_CTcor, align="hv", ncol = 3)

#name and save
Comb_SC_x_plot.file <- paste(outdir_combined, "Comb_mean_SCatlas.png", sep="/")
# Comb_SA_x_plot.file <- paste(outdir_combined, "Comb_mean_SAatlas.png", sep="/")
# Comb_CT_x_plot.file <- paste(outdir_combined, "Comb_mean_CTatlas.png", sep="/")
Comb_Cort_x_plot.file <- paste(outdir_combined, "Comb_mean_CORTatlas.png", sep="/")
# ggsave(Comb_SA_x_plot.file, Comb_SA_x_plot, dpi=300, width = 21, height = 10, units = "cm")
# ggsave(Comb_CT_x_plot.file, Comb_CT_x_plot, dpi=300, width = 21, height = 10, units = "cm")
ggsave(Comb_SC_x_plot.file, Comb_SC_x_plot, dpi=300, width = 21, height = 10, units = "cm")
ggsave(Comb_Cort_x_plot.file, Comb_Cort_x_plot, dpi=300, width = 21, height = 20, units = "cm")

#global
Comb_OV_Vio <- plot_grid((PNC_OVplots_vio[[1]] + ylab("Total Brain Volume") + ylim(-4,4) +
                            theme(axis.ticks.x=element_blank())), NULL,
                          (HCP_OVplots_vio[[1]] + ylab("Total Brain Volume") + ylim(-4,4) +
                           theme(axis.ticks.x=element_blank())), NULL ,
                          (OASIS_OVplots_vio[[1]] + ylab("Total Brain Volume") + ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), NULL,
          (PNC_OVplots_vio[[2]] +ylab("Cerebral Grey Matter") + ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (PNC_OVplots_vio.res[[2]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (HCP_OVplots_vio[[2]] +ylab("Cerebral Grey Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (HCP_OVplots_vio.res[[2]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (OASIS_OVplots_vio[[2]] +ylab("Cerebral Grey Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (OASIS_OVplots_vio.res[[2]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (PNC_OVplots_vio[[3]] +ylab("Cerebral White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (PNC_OVplots_vio.res[[3]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (HCP_OVplots_vio[[3]] +ylab("Cerebral White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (HCP_OVplots_vio.res[[3]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (OASIS_OVplots_vio[[3]] +ylab("Cerebral White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (OASIS_OVplots_vio.res[[3]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (PNC_OVplots_vio[[4]] +ylab("Cerebellar Grey Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (PNC_OVplots_vio.res[[4]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (HCP_OVplots_vio[[4]] +ylab("Cerebellar Grey Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (HCP_OVplots_vio.res[[4]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (OASIS_OVplots_vio[[4]] +ylab("Cerebellar Grey Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (OASIS_OVplots_vio.res[[4]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (PNC_OVplots_vio[[5]] +ylab("Cerebellar White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (PNC_OVplots_vio.res[[5]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (HCP_OVplots_vio[[5]] +ylab("Cerebellar White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (HCP_OVplots_vio.res[[5]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          (OASIS_OVplots_vio[[5]] +ylab("Cerebellar White Matter")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())), (OASIS_OVplots_vio.res[[5]] +ylab("")+ ylim(-4,4) +
                             theme(axis.ticks.x=element_blank())),
          align="hv", ncol =6)#,
          # labels=c('A','','B','','','','','','','',''), label_size=12)

Comb_OV_Vio.file <- paste(outdir_combined, "HCP_PNC_OASIS_OV_Vio.png", sep="/")
ggsave(Comb_OV_Vio.file, Comb_OV_Vio, dpi=300, width = 30, height = 20, units = "cm")

```